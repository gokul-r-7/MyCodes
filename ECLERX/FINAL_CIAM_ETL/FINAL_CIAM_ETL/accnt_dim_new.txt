WITH customer_data AS (
SELECT distinct c.customer_key,
CAST(c.account_nbr AS varchar) AS account_nbr,
c.site_id,
c.res_comm_ind,
c.customer_status_cd,
CAST(c.account_guid AS varchar) AS account_guid,
CAST(c.prim_account_holder_guid AS varchar) AS prim_account_holder_guid,
c.test_account_key AS test_account_key,
c.inception_dt
FROM edw.customer_dim c
where test_account_key=2
),
revenue_data AS (
SELECT r.customer_key,
r.site_id,
r.dwelling_type_key,
r.easy_pay_flag,
case when r.mobile_gross_mrc > 0 then '1' else '0' end as Mobile_Flag,
           r.customer_substatus_key,
		   r.time_key
    FROM edw.customer_revenue_fact r
	 WHERE r.bill_type_key != 2 and
    DATE_PARSE(r.time_key, '%Y-%m-%d') >= DATE_ADD('month', -13, CURRENT_DATE)
),
customer_status As
(select customer_substatus_key,sub_status_desc from edw.customer_substatus_dim),
dwelling_data AS (
    SELECT distinct d.dwelling_type_key,
           d.dwelling_type_desc
    FROM edw.dwelling_type_dim d
),
account_summary AS (
    SELECT
           s.customer_key,
           s.employee_flag,
           s.data_flag,
           s.site_id,
           s.cable_flag,
           s.wireless_flag,
           s.do_not_call_flag,
           s.do_not_email_flag,
           s.do_not_mail_flag,
           s.telephony_flag ,
           s.do_not_market_flag,
           s.time_key,
           ROW_NUMBER() OVER (PARTITION BY s.customer_key ORDER BY s.time_key DESC) AS rn
    FROM edw.cust_acct_sum s
),
guid_data AS (
    SELECT g.customer_key,
           g.create_dt,
           g.household_member_guid,
           ROW_NUMBER() over (partition by g.customer_key order by g.create_dt asc) as rn
           FROM edw.customer_guid_dtl_dim g
),
ivr_contact AS (
    SELECT
        i.customer_key,
        DATE_FORMAT(CAST(i.time_key AS TIMESTAMP), '%Y-%m') AS Contact_Month,
        MAX(i.time_key) AS Last_Contacted_Date_IVR_Call
    FROM "call"."call_ivr_fact" i
    GROUP BY i.customer_key, DATE_FORMAT(CAST(i.time_key AS TIMESTAMP), '%Y-%m')
),
web_data AS (
    SELECT
        d.customer_key,
        DATE_FORMAT(CAST(d.dt AS TIMESTAMP), '%Y-%m') AS Contact_Month,
        MAX(d.dt) AS Last_Contacted_Date_Cox_com,
        ROW_NUMBER() OVER (PARTITION BY d.customer_key ORDER BY dt) AS rn
    FROM webanalytics.web_contact_history d
    GROUP BY d.customer_key, DATE_FORMAT(CAST(d.dt AS TIMESTAMP), '%Y-%m'),dt
),
mob_data AS (
    SELECT
        mob.customer_key,
        DATE_FORMAT(CAST(mob.dt AS TIMESTAMP), '%Y-%m') AS Contact_Month,
        MAX(mob.dt) AS Last_Contacted_Date_Cox_App,
        ROW_NUMBER() OVER (PARTITION BY mob.customer_key ORDER BY dt) AS rn
    FROM mobile_data_temp.app_contact_history mob
    GROUP BY mob.customer_key, DATE_FORMAT(CAST(mob.dt AS TIMESTAMP), '%Y-%m'),dt
),
web_contact AS (
        SELECT
        campaign,
        evar61_coxcust_guid,
        min(dt) as dt,
        ROW_NUMBER() OVER (PARTITION BY evar61_coxcust_guid ORDER BY MIN(dt)) AS rn
    FROM webanalytics.web_contact_history
    WHERE visits IN (
        SELECT DISTINCT visits
        FROM webanalytics.web_contact_history
        WHERE pagename = 'cox:res:myprofile:reg:confirmation')
        group by 
        campaign,
        evar61_coxcust_guid),
app_contact AS (
    SELECT
        coxcust_guid_v61,
        Min(dt) as dt,
        post_evar40,
		ROW_NUMBER() OVER (PARTITION BY coxcust_guid_v61 ORDER BY MIN(dt)) AS rn
    FROM mobile_data_temp.app_contact_history
    WHERE visits IN (
        SELECT DISTINCT visits
        FROM mobile_data_temp.app_contact_history
        WHERE pagename = 'coxapp:reg:confirmation')
        group by coxcust_guid_v61,post_evar40
)
SELECT distinct
    r.customer_key AS Customer_Key,
    c.account_nbr AS Account_Nbr,
    r.site_id AS Site_Id,
    c.res_comm_ind AS Res_Com_Ind,
    c.customer_status_cd AS Customer_Status,
    d.dwelling_type_desc AS House_Type,
    c.account_guid AS Account_GUID,
    c.prim_account_holder_guid AS User_GUID_Primary,
    s.employee_flag AS Employee_Flag,
    c.test_account_key AS Test_Account_Flag,
    c.inception_dt AS Inception_Date,
    CAST(NULL AS varchar) AS "Sale_Acquisition_Channel",
    g.create_dt AS Registration_Date,
    COALESCE(web.campaign, app.post_evar40) AS Registration_Traffic_Source_Detail,
    CASE
    WHEN LOWER(COALESCE(web.campaign, app.post_evar40)) LIKE 'cr_em_cns_ocall_event255' THEN 'Email-Order'
    WHEN LOWER(COALESCE(web.campaign, app.post_evar40)) LIKE 'cr_em_z_acct_onb%' THEN 'Email-Onboarding'
    WHEN LOWER(COALESCE(web.campaign, app.post_evar40)) LIKE 'cr_em%' THEN 'Email-Others'
    WHEN LOWER(COALESCE(web.campaign, app.post_evar40)) LIKE 'cr_sms%' THEN 'sms'
    WHEN LOWER(COALESCE(web.campaign, app.post_evar40)) LIKE 'cr_dm%' THEN 'direct mail'
    WHEN SUBSTRING(LOWER(COALESCE(web.campaign, app.post_evar40)), LENGTH(COALESCE(web.campaign, app.post_evar40)) - 5, 6) = 'vanity' THEN 'Vanity URL'
    WHEN LOWER(COALESCE(web.campaign, app.post_evar40)) LIKE '%panoapp%' THEN 'panoapp'
    WHEN COALESCE(web.campaign, app.post_evar40) IS NOT NULL AND LENGTH(COALESCE(web.campaign, app.post_evar40)) > 0 THEN 'organic'
    ELSE 'null'  
    END AS Registration_Traffic_Source,
    s.data_flag AS Data_Flag,
    s.cable_flag AS TV_Flag,
    s.telephony_flag AS "Phone_Flag",
    CAST(NULL AS varchar) AS "Homelife_Flag",
    r.Mobile_Flag,
    cd.sub_status_desc,
    CAST(NULL AS varchar) AS "Pano_Flag",
    CAST(NULL AS varchar) AS "Pano_Device",
    r.easy_pay_flag AS Easy_Pay_Flag,
    s.do_not_call_flag AS Do_Not_Call_Flag,
    s.do_not_email_flag AS Do_Not_Email_Flag,
    s.do_not_mail_flag AS Do_Not_Mail_Flag,
    s.do_not_market_flag AS Do_Not_Market_Flag,
    ivr.Last_Contacted_Date_IVR_Call,
    w.Last_Contacted_Date_Cox_com,
    mob.Last_Contacted_Date_Cox_App, 
    CAST(NULL AS varchar) AS "Cox_Segment",
    CAST(NULL AS varchar) AS "Demographic_Info1",
    CAST(NULL AS varchar) AS "Demographic_Info2",
    r.time_key
FROM revenue_data r LEFT JOIN dwelling_data d ON r.dwelling_type_key = d.dwelling_type_key
LEFT JOIN (select * from account_summary where rn=1)s ON r.customer_key = CAST(s.customer_key AS double)
LEFT JOIN customer_status cd on r.customer_substatus_key=cd.customer_substatus_key 
LEFT JOIN customer_data c ON r.customer_key = CAST(c.customer_key AS double)
LEFT JOIN (select * from guid_data where rn=1) g ON r.customer_key = CAST(g.customer_key AS double)
LEFT JOIN ivr_contact ivr
    ON r.customer_key = CAST(ivr.customer_key AS double)
    AND DATE_FORMAT(CAST(r.time_key AS TIMESTAMP), '%Y-%m') >= ivr.Contact_Month
LEFT JOIN web_data w
    ON r.customer_key = CAST(w.customer_key AS double)
    AND DATE_FORMAT(CAST(r.time_key AS TIMESTAMP), '%Y-%m') >= w.Contact_Month and w.rn=1
LEFT JOIN mob_data mob
    ON r.customer_key = CAST(mob.customer_key AS double) and mob.rn=1
    AND DATE_FORMAT(CAST(r.time_key AS TIMESTAMP), '%Y-%m') >= mob.Contact_Month
LEFT JOIN (select * from web_contact where rn=1) web ON g.household_member_guid = web.evar61_coxcust_guid
LEFT JOIN (select * from app_contact where rn=1) app ON g.household_member_guid = app.coxcust_guid_v61