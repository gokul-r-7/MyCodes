{%- set run_date = "CURRENT_TIMESTAMP()" -%}
{{
    config(
        materialized='incremental',
        incremental_strategy='insert_overwrite',
        file_format='iceberg',
        iceberg_expire_snapshots='False', 
        custom_location=target.location ~ 'transformed_aim_tags_pwrbi/',
        table_properties={'write.target-file-size-bytes': '268435456'},
        on_schema_change='append_new_columns',
        full_refresh=true
        ) 
}}

select
    plant_item_number,
    loaded_via_interface_s_,
    removed_from_interface_s_,
    object_on_p_id,
    object_in_3d_system,
    object_in_list_schedule,
    object_in_procurement_syst,
    ism_tag_type_link,
    classid,
    classname,
    object_in_mtr,
    parentclassid,
    parent_classname,
    plant_item_type_name,
    link_to_lineid,
    da_00044_p_id_number,
    fa_00388_operational_statu,
    ga_00001_number,
    ga_00002_description,
    ga_00007_pbs_area,
    ga_00008_pbs_unit,
    fa_00097_equipment_type,
    pa_00120_location,
    fa_00250_related_equipment,
    fa_00390_parent_number,
    fa_00392_function_code,
    fa_00433_from_tag,
    fa_00434_to_tag,
    fa_00096_elect_load_l_flag,
    fa_00130_in_line_flag,
    fa_00439_hazardous_area_fl,
    ga_00010_purchase_order_nu,
    pa_00198_supplier,
    ga_00019_requisition,
    fa_00438_supply_responsibi,
    pa_00144_originating_contr,
    pa_00145_origin_contr_code,
    fa_00305_tag_criticality_r,
    pa_00196_original_equip_ma,
    pa_00136_original_equip_mo,
    pa_00139_original_equip_se,
    pa_00197_original_equip_pa,
    ga_00016_loop,
    pa_00018_route,
    fa_00068_temp_des_min,
    fa_00068_temp_des_min_uom,
    fa_00077_temp_des_max,
    fa_00077_temp_des_max_uom,
    fa_00078_temp_des_max_alt,
    fa_00078_temp_des_max_alt_uom,
    fa_00178_press_des_max_alt,
    fa_00178_press_des_max_alt_uom,
    fa_00361_press_des_min,
    fa_00361_press_des_min_uom,
    fa_00363_press_des_max,
    fa_00363_press_des_max_uom,
    pa_00019_segregation_level,
    pa_00037_arrangement___con,
    pa_00039_conductor_size,
    fa_00087___differential_he,
    fa_00087___differential_he_uom,
    fa_00104_failure_action,
    fa_00108_fluid_phase,
    fa_00109_fluid_service_cod,
    fa_00110_fluid_type,
    fa_00117_fullloadcurrent,
    fa_00117_fullloadcurrent_uom,
    pa_00097_voltage___insulat,
    pa_00102_diameter___intern,
    pa_00102_diameter___intern_uom,
    pa_00105_io_type,
    fa_00175_calib_range_max,
    fa_00177_calib_range_u_max,
    fa_00185_calib_range_min,
    fa_00187_calib_range_u_min,
    fa_00274_set_point,
    fa_00275_set_point_high,
    fa_00276_set_point_high_hi,
    fa_00277_set_point_low,
    fa_00278_set_point_low_low,
    fa_00285_signal___type,
    pa_00202_ingression_protec,
    pa_00213_additional_conduc,
    fa_00300_stress_criticalit,
    pa_00221_material,
    fa_00311_test_medium,
    fa_00327_temperature___tra,
    fa_00327_temperature___tra_uom,
    fa_00328_tracing_type,
    pa_00241_cleaning_code,
    pa_00246_diameter___nomina,
    pa_00246_diameter___nomina_uom,
    pa_00247_paint___specifica,
    pa_00248_piping_material_c,
    pa_00250_radiography,
    pa_00251_schedule,
    pa_00278_temp_oper_min,
    pa_00278_temp_oper_min_uom,
    pa_00283_press_oper_norm,
    pa_00283_press_oper_norm_uom,
    pa_00284_press_oper_max,
    pa_00284_press_oper_max_uom,
    pa_00286_temp_oper_norm,
    pa_00286_temp_oper_norm_uom,
    pa_00289_temp_oper_max,
    pa_00289_temp_oper_max_uom,
    pa_00008_atex_code,
    pa_00084_haz_area_cer_au,
    pa_00085_haz_area_cer_nu,
    pa_00086_haz_area_cer_st,
    pa_00087_haz_area_temp_ra,
    pa_00272_haz_area_class,
    pa_00273_haz_area_gas_gr,
    pa_00243_insulation_materi,
    pa_00244_insulation_thickn,
    pa_00244_insulation_thickn_uom,
    pa_00245_insulation_type,
    pa_00069_length___installe,
    pa_00069_length___installe_uom,
    fa_00141_length___estimate,
    fa_00141_length___estimate_uom,
    pa_00113_length___spare,
    pa_00113_length___spare_uom,
    pa_00116_length___tail_1,
    pa_00116_length___tail_1_uom,
    pa_00117_length___tail_2,
    pa_00117_length___tail_2_uom,
    pa_00123_bending_radius,
    pa_00123_bending_radius_uom,
    pa_00237_weight_per_length,
    pa_00237_weight_per_length_uom,
    pa_00206_cable_num_of_para,
    pa_00207_number_of_splices,
    pa_00216_outside_diameter,
    pa_00216_outside_diameter_uom,
    pa_00089_height,
    pa_00089_height_uom,
    pa_00112_length,
    pa_00112_length_uom,
    pa_00257_width,
    pa_00257_width_uom,
    pa_00114_length___tan_to_t,
    pa_00114_length___tan_to_t_uom,
    fa_00060_current___rating,
    fa_00060_current___rating_uom,
    fa_00193_nde,
    fa_00271_tagsequenceno,
    pa_00143_orifice_size,
    pa_00143_orifice_size_uom,
    pa_00160_capacity___rated,
    pa_00160_capacity___rated_uom,
    pa_00163_power___rated,
    pa_00163_power___rated_uom,
    pa_00165_voltage___rated,
    ga_00014_constr_work_pack,
    wbs_location_code,
    alt_wbs_location_code,
    const_zone_code,
    const_zone_description,
    ga_00015_eng_work_pack,
    fa_00040_commissioning_sub,
    fa_00042_commissioning_sys,
    pa_00305_constr_status,
    ga_00006_pbs_plant,
    pa_00186_warranty,
    pa_00301_weight___empty,
    pa_00301_weight___empty_uom,
    da_00044_p_id_number_link,
    da_00007_datasheet_no_link,
    pbs_plant_description,
    pbs_area_description,
    pbs_unit_description,
    tag_class_discipline,
    e3d_name,
    inspection,
    pa_00260_orientation,
    normal_operating_volume_fl,
    normal_operating_volume_fl_uom,
    fa_00027_capacity,
    fa_00027_capacity_uom,
    fa_00316_thermal_duty__pow,
    fa_00316_thermal_duty__pow_uom,
    pa_00071_driver_type,
    pa_00150_power___consumpti,
    pa_00150_power___consumpti_uom,
    pa_00165_voltage___rated__,
    pa_00165_voltage___rated___uom,
    normal_operating_pressure,
    normal_operating_pressure_uom,
    normal_operating_inlet_pre,
    normal_operating_inlet_pre_uom,
    normal_operating_outlet_pr,
    normal_operating_outlet_pr_uom,
    fa_00072_pressure___design,
    fa_00072_pressure___design_uom,
    pa_00189_weight___operatin,
    pa_00189_weight___operatin_uom,
    pa_00190_weight___test,
    pa_00190_weight___test_uom,
    outside_surface_area,
    outside_surface_area_uom,
    seal_type,
    pa_00176_supplier_model_nu,
    fa_00087_diff_head,
    fa_00087_diff_head_uom,
    fluid_service_code_descrip,
    molecular_weight,
    fa_00062_density,
    fa_00062_density_uom,
    norm_oper_dyn_visc,
    norm_oper_dyn_visc_uom,
    norm_oper_mass_flow_rate,
    norm_oper_mass_flow_rate_uom,
    norm_oper_flow_velocity,
    norm_oper_flow_velocity_uom,
    nominal_wall_thickness,
    nominal_wall_thickness_uom,
    pa_00214_corrosion_allowan,
    pa_00214_corrosion_allowan_uom,
    pa_00255_pressure___test,
    pa_00255_pressure___test_uom,
    fa_00239_post_weld_heat_tr,
    chemical_cleaning_required,
    pa_00254_test_medium,
    fa_00118_location___functi,
    fa_00049_control_system_ty,
    output_signal_range,
    calibration_range,
    fa_dac00003_sp_low_low_low,
    fa_dac00002_sp_high_hi_hi,
    pa_00170_size,
    pa_00170_size_uom,
    da_00007_datasheet_number,
    pa_00021_cable___specifica,
    da_00062_single_line_diagr,
    pa_00262_coating___externa,
    in_instrument_index,
    ga_00015_ewp_link,
    commodity_code,
    spi_name,
    name_as_it_appears_on_p_id,
    remarks,
    fa_00383_soft_tag_flag,
    da_00033_loop_drawing_doc_,
    da_00033_loop_drawing_docu,
    process_cell,
    process_unit_code,
    pa_00277_pressure___operat,
    pa_00277_pressure___operat_uom,
    client_property_tag,
    ga_00018_short_description,
    ga_00012__fire_zone,
    fa_00076_pressure___design,
    fa_00076_pressure___design_uom,
    fa_00074_pressure___design,
    fa_00074_pressure___design_uom,
    pa_00191_weight___transpor,
    pa_00191_weight___transpor_uom,
    number_of_cores,
    udf_01_loop_type,
    pa_000xx_contract_delivery,
    pa_000xx_contract_delivery_uom,
    pa_000xx_forecast_delivery,
    pa_000xx_forecast_delivery_uom,
    pa_000xx_actual_delivery_d,
    pa_000xx_actual_delivery_d_uom,
    pa_000xx_forecast_arrival_,
    pa_000xx_forecast_arrival__uom,
    pa_000xx_actual_arrival_on,
    pa_000xx_actual_arrival_on_uom,
    pa_000xx_received_status,
    fa_00015_applicable_design,
    ga_00025_tag_maturity_leve,
    object_in_spi,
    da_000xx_equipment_list,
    mtr_view_name,
    pa_00073_efficiency,
    fa_00090_discipline,
    pa_00299_power_factor___fu,
    pa_00074_efficiency___full,
    da_00xxx_datasht_num_rev,
    fa_00031_circuit_type,
    ga_00024_tag_engineering_s,
    udf_02_modifiedby,
    udf_date_01_modified,
    udf_date_01_modified_uom,
    ga_00014_cwp_link,
    fa_00024_cable___assembly,
    circuit_number,
    pa_00151_power_factor___at,
    pa_00315_load___rated___ac,
    pa_00315_load___rated___ac_uom,
    pa_00316_load___rated___ap,
    pa_00316_load___rated___ap_uom,
    pa_00317_load___rated___re,
    pa_00317_load___rated___re_uom,
    project,
    pa_000xx_expediter,
    {{run_date}} as model_created_date,
    {{run_date}} as model_updated_date,
    {{ generate_load_id(model) }} as model_load_id,
    'VGCP2' as project_code,
    cast(execution_date as date) as extracted_date,
    object_type,
    object_in_pdm,
    object_in_spel,
    object_in_mel,
    constr_work_pack_name,
    required_in_pid,
    required_in_list,
    required_in_3d,
    required_in_procurement,
    required_in_spi,
    required__in_equipment_lis,
    required_in_spel,
    required_in_line_list,
    required_in_mtr,
    scope_status,
    `tag to po` as tag_to_po,
    plant_area,
    unit,
    sub_unit,
    source_system_name,
    alt_wbs_location_code as WBS,
    SUBSTRING(ga_00014_constr_work_pack, 2, 2) AS CWA,
    SUBSTRING(ga_00014_constr_work_pack, 2, 4) AS CWP_ZONE,
    'VGCP2'|| '_' ||COALESCE(alt_wbs_location_code, '')|| '_' ||
    COALESCE(SUBSTRING(ga_00014_constr_work_pack, 2, 2), '')|| '_' ||COALESCE(SUBSTRING(ga_00014_constr_work_pack, 2, 4) , '')
    AS PROJECT_CODE_WBS_CWA_CWPZONE  

from
    (
        select
            p.*,
            `tag to po`,
            case
            when position('"' in plant_item_number) > (0) then substring(
                plant_item_number,
                (position('"' in plant_item_number)) + 2,
                1
            )
            when position('[' in plant_item_number) > (0) then substring(
                plant_item_number,
                (position('[' in plant_item_number)) + 1,
                1
            )
            else substring(plant_item_number, 1, 1) end as plant_area,
            case
            when position('"' in plant_item_number) > (0) then substring(
                plant_item_number,
                (position('"' in plant_item_number)) + 3,
                2
            )
            when position('[' in plant_item_number) > (0) then substring(
                plant_item_number,
                (position('[' in plant_item_number)) + 2,
                2
            )
            else substring(plant_item_number, 2, 2) end as unit,
            case
            when position('"' in plant_item_number) > (0) then substring(
                plant_item_number,
                (position('"' in plant_item_number)) + 6,
                2
            )
            when position('[' in plant_item_number) > (0) then substring(
                plant_item_number,
                (position('[' in plant_item_number)) + 5,
                2
            )
            else substring(plant_item_number, 5, 2) end as sub_unit
        from
            {{ source('curated_aim', 'curated_vwe_vg_cp2_tags_pwrbi') }} p
            left outer join {{ source('curated_aim', 'curated_tag_to_po') }}	 d on nullif(upper(p.object_type), '') || nullif(upper(p.classname), '') = nullif(upper(d.object_type), '') || nullif(upper(d.classname), '') --where project_code = 'VGCP2'
    )
	
